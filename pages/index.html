<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index List</title>

    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link rel="stylesheet" href="/resources/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --bg-header : #303641;
        }

        .bg-header {
            background-color: var(--bg-header);
        }

        html{
            height: 100%;
        }

        #wrap {
            min-height: 100vh;
            height: 100%;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
            background-color: #fafdff;
        }

        footer {
            margin-top: auto;
            font-size: 15px;
            color: #666;
        }

        th, td {
            vertical-align: middle;
        }

        th {
            background-color: #eee;
        }

        td {
            font-size: 15px;
        }

        button {
            padding: 0;
            outline: 0;
            border: 0;
            margin: 0;
        }

        button.edit, 
        button.delete,
        button.save,
        button.cancel  {
            transition: all 0.5s;
        }

        button.edit:hover, 
        button.delete:hover,
        button.save:hover,
        button.cancel {
            transform: scale(1.15);
        }

        button.edit {
            width: 16px;
            height: 16px;
            background: url(../assets/ico/pen-to-square-regular.svg) no-repeat center / cover;
        }

        button.delete {
            width: 16px;
            height: 16px;
            background: url(../assets/ico/trash-can-regular.svg) no-repeat center / cover;
        }

        button.save {
            width: 16px;
            height: 16px;
            background: url(../assets/ico/floppy-disk-solid.svg) no-repeat center / cover;
        }

        button.cancel {
            width: 16px;
            height: 16px;
            background: url(../assets/ico/x-solid.svg) no-repeat center / cover;
        }

        html, body, 
        *, *::before, *::after {
            font-family: "Pretendard Variable", Pretendard, 
            -apple-system, BlinkMacSystemFont, system-ui, Roboto, 
            "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", 
            "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", 
            "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
        }

        textarea {
            resize: none;
        }

        table tr:hover > td {
            background-color: #eee;
        }

        input[type="checkbox"], button {
            cursor: pointer;
        }

        a {
            text-decoration: none;
        }

        .mr-10 {
            margin-right: 100px;
        }

        .mb-10 {
            margin-bottom: 100px;
        }
    </style>
</head>
<body>
    <div id="wrap">
        <nav class="navbar mb-4 border-bottom bg-header">
            <div class="container-lg">
                <a class="d-flex align-items-center gap-2 navbar-brand" href="#">
                    <img src="../assets/logo/index_logo.svg" width="170" alt="Logo" class="d-inline-block align-text-top">
                </a>
                <form class="d-flex" role="search">
                    <input class="form-control me-2" type="search" placeholder="페이지명 검색" aria-label="Search"/>
                    <button class="btn btn-primary" type="submit">
                        <img src="../assets/ico/search-line-white.svg" alt="">
                    </button>
                </form>
            </div>
        </nav>
        <div class="container-fluid">         
            <div class="container-lg">
                <div class="table-responsive">
                    <table class="table w-100 table-bordered">
                        <colgroup>
                            <col style="width: 40px;">
                            <col style="width: 300px;">
                            <col style="width: 300px;">
                            <col style="width: 80px">
                            <col style="width: 400px">
                            <col style="width: 80px;">
                        </colgroup>
                        <thead>
                            <th class="text-center">ID</th>
                            <th>화면명</th>
                            <th>URL</th>
                            <th class="text-center">완료</th>
                            <th>비고</th>
                            <th class="text-center">액션</th>
                        </thead>
                        <tbody id="pagesTableBody">
                            <tr>
                            
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex mb-2">
                    <button type="button" class="btn btn-dark">신규 페이지 생성</button>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-end fixed-bottom container-lg">
            <div class="card mb-10">
                <div class="card-body">
                    <ul class="d-flex align-items-center gap-3 list-unstyled">
                        <li>
                            <strong>총 페이지</strong>
                            <span>33</span>
                        </li>
                        <li>
                            <strong>완료 페이지</strong>
                            <span>26</span>
                        </li>
                        <li>
                            <strong>잔여 페이지</strong>
                            <span>7</span>
                        </li>
                    </ul>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 80%;" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100">80%</div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="border-top p-4 bg-light">
            <p class="text-center mb-0">@copyright 2026 mhlee reserved</p>
        </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script>
        $(function(){

            function getPagesData() {
                $.getJSON('../pageData.json', function(data) {
                    const tbody = $('#pagesTableBody');
                    tbody.empty();

                    data.forEach((page, index) => {
                        const basePath = './';
                        const tr = $('<tr data-id="' + page.id + '"></tr>'); // 행 단위 ID 관리

                        // 1. ID (수정 불가)
                        tr.append(`<td class="text-center">${page.id}</td>`);

                        // 2. 화면명 (Input 토글)
                        tr.append(`
                            <td data-col="title">
                                <span class="view-mode">${page.title}</span>
                                <input type="text" class="form-control edit-mode" style="display:none;" value="${page.title}">
                            </td>
                        `);

                        // 3. URL (Input 토글)
                        tr.append(`
                            <td data-col="url">
                                <a href="${basePath}${page.url}" class="view-mode">${page.url}</a>
                                <input type="text" class="form-control edit-mode" style="display:none;" value="${page.url}">
                            </td>
                        `);

                        // 4. 상태 (Checkbox 활성화 토글)
                        const isChecked = page.status == 'true' ? 'checked' : '';
                        tr.append(`
                            <td class="text-center" data-col="status">
                                <input class="form-check-input status-chk" type="checkbox" ${isChecked} disabled>
                                <span class="status-check" style="display: none">${isChecked}</span>
                            </td>
                        `);

                        // 5. 비고 (Textarea 토글)
                        tr.append(`
                            <td data-col="body">
                                <p class="text-muted view-mode" style="margin-bottom:0;">${page.body || ""}</p>
                                <textarea id="${'textarea-' + page.id}" class="form-control edit-mode" style="display:none;" rows="4">${page.body || ""}</textarea>
                            </td>
                        `);

                        // 6. 액션 버튼 (Font Awesome 아이콘 활용)
                        const actionHtml = `
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="edit"></button>
                                    <button class="cancel" style="display: none;"></button>
                                    <button class="save" style="display: none;"></button>
                                    <button class="delete"></button>
                                </div>
                            </td>
                        `;
                        tr.append(actionHtml);

                        tbody.append(tr);
                    });
                }).fail(function() {
                    console.error('JSON 파일을 불러올 수 없습니다.');
                    $('#pagesTableBody').html('<tr><td colspan="6" class="text-center">데이터를 불러올 수 없습니다.</td></tr>');
                });
            }

            getPagesData();
            checkServerConnection();

            let serverConnect = true;
            
            function checkServerConnection() {
                $.ajax({
                    url: 'http://localhost:3000/',
                    type: 'POST',
                    data: "서버테스트",
                    timeout: 2000,
                    success: function(response) {
                        console.log("서버 연결 확인: 정상");

                        serverConnect = true;
                    },
                    error: function(error) {
                        console.warn("서버 연결 확인: 실패 - 버튼을 비활성화합니다.");

                        serverConnect = false;
                    }
                })
            }

            /* 
                수정 워크 플로우 

                수정 버튼 클릭시 
                - 1. 자신과 가장 가까운 tr을 찾음
                    1.1 자기 자신을 hide하고 cancle 버튼과 save 버튼을 show 함
                    1.2 edit-mode show, view-mode hide 
                    1.3 tr에서 status에 disabled를 삭제함
                    
                X 버튼 클릭시 
                - 1. 자신과 가장 가까운 tr을 찾음 
                    1.1 자기 자신을 hide하고 edit 버튼을 show함
                    1.2 edit-mode hide, view-mode show
                    1.3 tr에서 status에 disabled를 활성화함
                    1.4 모든 input과 textArea를 기존 viewmode의 text로 초기화함
                
                저장 버튼 클릭 시 
                - 1. 자신과 가장 가까운 tr을 찾음 
                    1.1 해당 요소의 각각 값을 찾아 data를 update/status함
                        1.1.1 성공시 
                            1.1.1.1 getJSON으로 신규 변경된 데이터를 fetching함
                            1.1.1.2 view mode를 hide하고 edit mode를 활성화함
                        1.1.2 실패 시
                            1.1.2.1 alert로 저장 실패를 알리고 console에는 error를 전달함
                            1.1.2.2 view mode를 hide하고 edit mode를 활성화함
            */

            // 수정
            $(document).on('click', '.edit', function(){
                if (!serverConnect) {
                    alert("서버가 연결되어 있지 않습니다.");

                    return;
                }

                const $tr = $(this).closest('tr');

                $(this).hide();
                $tr.find('.cancel, .save').show();

                $tr.find('.edit-mode').show();
                $tr.find('.view-mode').hide();

                $tr.find('input[type="checkbox"]').removeAttr('disabled');
            })


            // 수정 취소
            $(document).on('click', '.cancel', function(){
                if (!serverConnect) {
                    alert("서버가 연결되어 있지 않습니다.");

                    return;
                }

                const $tr = $(this).closest('tr');

                $tr.find('input, textarea').each(function(idx, item){
                    if ($(this).attr('type') == "checkbox") {                    
                        const originStatus = $(this).siblings('.status-check').text();
                        const isChecked = originStatus == "checked" ? true : false;
                        
                        $(this).prop('checked', isChecked);
                    }
                    
                    const originTxt = $(this).siblings('.view-mode').text();

                    $(this).val(originTxt);
                })

                $(this).hide();
                $tr.find('.save').hide();
                $tr.find('.edit').show();            

                $tr.find('.edit-mode').hide();
                $tr.find('.view-mode').show();
                $tr.find('input[type="checkbox"]').attr('disabled', true);
            })
            
            $(document).on('click', '.save', function(){
                if (!serverConnect) {
                    alert("서버가 연결되어 있지 않습니다.");

                    return;
                }

                const $tr = $(this).closest('tr');
                const targetId = $tr.attr('data-id');
                const isChecked = $tr.find('input[type="checkbox"]').prop('checked');
                const title = $tr.find('td[data-col="title"] input').val();
                const body = $tr.find('td[data-col="body"] textarea').val();
                const url = $tr.find('td[data-col="url"] input').val();

                var dataToSend = {
                    id : Number(targetId),
                    title: title,
                    url: url,
                    body: body,
                    status: isChecked
                }

                $.ajax({
                    url: 'http://localhost:3000/update-info',
                    type: 'POST',
                    data: dataToSend,
                    success: function(response){
                        console.log("성공", response);
                    },
                    error: function(error) {
                        console.error("오류", error)
                    }
                })
            })        

            $(document).on('click', '.delete', function(){
                if (!serverConnect) {
                    alert("서버가 연결되어 있지 않습니다.");

                    return;
                }
            })
        })
    </script>
</body>
</html>