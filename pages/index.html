<!doctype html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Index List</title>
        <link
            rel="stylesheet"
            as="style"
            crossorigin
            href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
        />
        <link rel="stylesheet" href="/resources/style.css" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
        <style>
            :root {
                --bg-header: #303641;
            }

            .bg-header {
                background-color: var(--bg-header);
            }

            html {
                height: 100%;
            }

            .view-mode,
            .edit-mode {
                white-space: pre-wrap;
            }

            #wrap {
                min-height: 100vh;
                height: 100%;
                display: flex;
                flex-direction: column;
                margin: 0 auto;
                background-color: #fafdff;
            }

            footer {
                margin-top: auto;
                font-size: 15px;
                color: #666;
            }

            th,
            td {
                vertical-align: middle;
            }

            th {
                background-color: #eee;
            }

            td {
                font-size: 15px;
            }

            button {
                padding: 0;
                outline: 0;
                border: 0;
                margin: 0;
            }

            button.edit,
            button.delete,
            button.save,
            button.cancel {
                transition: all 0.5s;
            }

            button.edit:hover,
            button.delete:hover,
            button.save:hover,
            button.cancel {
                transform: scale(1.15);
            }

            button.edit {
                width: 16px;
                height: 16px;
                background: url(/assets/ico/pen-to-square-regular.svg) no-repeat center / cover;
            }

            button.delete {
                width: 16px;
                height: 16px;
                background: url(/assets/ico/trash-can-regular.svg) no-repeat center / cover;
            }

            button.save {
                width: 16px;
                height: 16px;
                background: url(/assets/ico/floppy-disk-solid.svg) no-repeat center / cover;
            }

            button.cancel {
                width: 16px;
                height: 16px;
                background: url(/assets/ico/x-solid.svg) no-repeat center / cover;
            }

            html,
            body,
            *,
            *::before,
            *::after {
                font-family:
                    "Pretendard Variable",
                    Pretendard,
                    -apple-system,
                    BlinkMacSystemFont,
                    system-ui,
                    Roboto,
                    "Helvetica Neue",
                    "Segoe UI",
                    "Apple SD Gothic Neo",
                    "Noto Sans KR",
                    "Malgun Gothic",
                    "Apple Color Emoji",
                    "Segoe UI Emoji",
                    "Segoe UI Symbol",
                    sans-serif;
            }

            textarea {
                font-size: 14px !important;
                height: auto;
                resize: none;
                overflow-y: hidden;
                min-height: 50px !important;
            }

            table tr:hover > td {
                background-color: #eee;
            }

            input[type="checkbox"],
            button {
                cursor: pointer;
            }

            a {
                text-decoration: none;
            }

            .mr-10 {
                margin-right: 100px;
            }

            .mb-10 {
                margin-bottom: 100px;
            }
        </style>
    </head>
    <body>
        <div id="wrap">
            <nav class="navbar mb-4 border-bottom bg-header">
                <div class="container-lg">
                    <a class="d-flex align-items-center gap-2 navbar-brand" href="#">
                        <img
                            src="../assets/logo/index_logo.svg"
                            width="170"
                            alt="Logo"
                            class="d-inline-block align-text-top"
                        />
                    </a>
                    <div class="d-flex">
                        <input
                            id="searchTerm"
                            class="form-control me-2"
                            type="search"
                            placeholder="페이지명 검색"
                            aria-label="Search"
                        />
                        <button id="searchConfirm" class="btn btn-primary" type="button">
                            <img src="../assets/ico/search-line-white.svg" alt="" />
                        </button>
                    </div>
                </div>
            </nav>
            <div class="container-fluid">
                <div class="container-lg">
                    <div class="table-responsive">
                        <table class="table w-100 table-bordered" id="pagesTable">
                            <colgroup>
                                <col style="width: 300px" />
                                <col style="width: 300px" />
                                <col style="width: 80px" />
                                <col style="width: 400px" />
                                <col style="width: 80px" />
                            </colgroup>
                            <thead class="table-light">
                                <th>화면명</th>
                                <th>URL</th>
                                <th class="text-center">완료</th>
                                <th>비고</th>
                                <th class="text-center">액션</th>
                            </thead>
                            <tbody id="pagesTableBody">
                                <tr></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex mb-2 justify-content-between">
                        <button type="button" class="btn btn-dark" id="createNewPage">신규 페이지 생성</button>
                        <div id="searchResultWrap">
                            <div class="d-flex mb-2">
                                <div class="d-flex gap-2 align-items-center bg-white">
                                    <span>검색 결과</span>
                                    <strong id="searchResult"></strong>
                                    <button id="searchReset" class="btn btn-secondary">초기화</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end fixed-bottom container-lg">
                <div class="card mb-10">
                    <div class="card-body">
                        <ul class="d-flex align-items-center gap-3 list-unstyled">
                            <li>
                                <strong>총 페이지</strong>
                                <span id="total"></span>
                            </li>
                            <li>
                                <strong>완료 페이지</strong>
                                <span id="done"></span>
                            </li>
                            <li>
                                <strong>잔여 페이지</strong>
                                <span id="remain"></span>
                            </li>
                        </ul>
                        <div class="progress">
                            <div
                                class="progress-bar"
                                id="progress"
                                role="progressbar"
                                aria-valuenow=""
                                aria-valuemin="0"
                                aria-valuemax="100"
                            ></div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="border-top p-4 bg-light">
                <p class="text-center mb-0">@copyright 2026 mhlee reserved</p>
            </footer>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
        <script
            src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
            crossorigin="anonymous"
        ></script>
        <script>
            $(function () {
                const baseUrl = "http://localhost:3000/";

                function callAjaxPost(data, domain) {
                    $.ajax({
                        url: baseUrl + domain,
                        type: "POST",
                        data: data,
                        success: function (response) {
                            console.log("성공", response);
                        },
                        error: function (error) {
                            console.error("오류", error);
                        },
                    });
                }

                function getFormData(target) {
                    // 데이터 추출
                    const data = {
                        id: target.attr("data-id"),
                        title: target.find('td[data-col="title"] input').val(),
                        url: target.find('td[data-col="url"] input').val(),
                        body: target.find('td[data-col="body"]').val(),
                        status: target.find('input[type="checkbox"]').prop("checked"),
                    };

                    // 데이터 유효성 검사
                    if (data.title.trim() === "") {
                        alert("화면명을 입력해주세요");

                        target.find('td[data-col="title"] input').focus();
                        return;
                    }

                    if (data.url.trim() === "" || !data.url.includes(".html")) {
                        alert("URL 형식이 잘못되었거나 공백입니다 다시 입력해주세요");

                        target.find('td[data-col="url"] input').focus();
                        return;
                    }

                    return data;
                }

                function countPagesData(data) {
                    const total = data.length;
                    let done = 0;

                    if (total === 0) return;

                    data.forEach((page, index) => {
                        if (page.status == "true") {
                            done++;
                        }
                    });

                    let remain = total - done;
                    let donePercent = Math.round((done / total) * 100);

                    $("#total").text(total);
                    $("#done").text(done);
                    $("#remain").text(remain);

                    $("#progress").css("width", donePercent + "%");
                    $("#progress").attr("aria-valuenow", donePercent);
                    $("#progress").text(donePercent + "%");
                }

                const colLength = $("#pagesTable").find("col").length;

                function returnNoDataTr(status) {
                    const display = status ? "table-row" : "none";

                    return `
                    <tr class="no-data-tr" style="display: ${display};">
                        <td class="text-center text-muted" colspan="${colLength}">
                            조회된 데이터가 없습니다.
                        </td>
                    </tr>
                    `;
                }

                function hideNoDataTr() {
                    $(".no-data-tr").css("display", "none");
                }

                function showNoDataTr() {
                    $(".no-data-tr").css("display", "table-row");
                }

                let searchList = null;

                function getPagesData() {
                    $.getJSON("/pageData.json", function (data) {
                        const tbody = $("#pagesTableBody");
                        tbody.empty();

                        if (data.length === 0) {
                            tbody.append(returnNoDataTr(true));
                        }

                        data.forEach((page, index) => {
                            const basePath = "./";
                            const tr = $('<tr class="data" data-id="' + page.id + '"></tr>'); // 행 단위 ID 관리

                            // 화면명 (Input 토글)
                            tr.append(`
                            <td data-col="title">
                                <span class="view-mode">${page.title}</span>
                                <input type="text" placeholder="화면명" class="form-control edit-mode" style="display:none;" value="${page.title}">
                            </td>
                        `);

                            // URL (Input 토글)
                            tr.append(`
                            <td data-col="url">
                                <a target="_blank" href="${basePath}${page.url}" class="view-mode">${page.url}</a>
                                <input type="text" placeholder="URL" class="form-control edit-mode" style="display:none;" value="${page.url}">
                            </td>
                        `);

                            // 상태 (Checkbox 활성화 토글)
                            const isChecked = page.status == "true" ? "checked" : "";
                            tr.append(`
                            <td data-col="status" class="text-center">
                                <input class="form-check-input status-chk" type="checkbox" ${isChecked} disabled>
                                <span class="status-check" style="display: none">${isChecked}</span>
                            </td>
                        `);

                            // 비고 (Textarea 토글)
                            const pageBodyStr = page.body.split("\n").join("<br/>");

                            tr.append(`
                            <td data-col="body">
                                <p class="text-muted view-mode" style="margin-bottom:0;">${pageBodyStr || ""}</p>
                                <textarea placeholder="비고" id="${"textarea-" + page.id}" class="form-control edit-mode" style="display:none;">${page.body || ""}</textarea>
                            </td>
                        `);

                            // 액션
                            const actionHtml = `
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="edit"></button>
                                    <button class="cancel" style="display: none;"></button>
                                    <button class="save" style="display: none;"></button>
                                    <button class="delete"></button>
                                </div>
                            </td>
                        `;
                            tr.append(actionHtml);

                            tbody.append(tr);

                            countPagesData(data);
                        });

                        // 데이터 반영 후
                        tbody.append(returnNoDataTr(false));
                        searchList = tbody.find("tr:not(.no-data-tr)");
                        $("#searchResultWrap").hide();
                    }).fail(function () {
                        console.error("JSON 파일을 불러올 수 없습니다.");
                        $("#pagesTableBody").html(
                            `<tr><td colspan="${colLength}" class="text-center">데이터를 불러올 수 없습니다.</td></tr>`,
                        );
                    });
                }

                getPagesData();
                checkServerConnection();

                // 서버 상태 확인
                let serverConnect = true;

                function checkServerConnection() {
                    $.ajax({
                        url: baseUrl,
                        type: "POST",
                        data: "서버테스트",
                        timeout: 100,
                        beforeSend: function () {
                            $("#pagesTable button").attr("disabled", true);
                        },
                        success: function (response) {
                            console.log("서버 연결 확인: 정상");
                            serverConnect = true;
                            $("#pagesTable button").removeAttr("disabled");
                        },
                        error: function (error) {
                            console.warn("서버 연결 확인: 실패 - 버튼을 비활성화합니다.");
                            serverConnect = false;

                            $("#pagesTable button").attr("disabled", true);
                        },
                    });
                }

                // 신규 생성 폼 이벤트 핸들러
                $("#createNewPage").on("click", function () {
                    handleCreateNewPage();
                });

                function dateFormat(date) {
                    let month = date.getMonth() + 1;
                    let day = date.getDate();
                    let hour = date.getHours();
                    let minute = date.getMinutes();
                    let second = date.getSeconds();

                    month = month >= 10 ? month : "0" + month;
                    day = day >= 10 ? day : "0" + day;
                    hour = hour >= 10 ? hour : "0" + hour;
                    minute = minute >= 10 ? minute : "0" + minute;
                    second = second >= 10 ? second : "0" + second;

                    return date.getFullYear() + "-" + month + "-" + day + hour + minute + second;
                }

                // 신규 생성 폼 생성
                function handleCreateNewPage() {
                    const createTime = dateFormat(new Date());

                    const editTr = `
                    <tr class="new" data-id="${createTime}">
                        <td data-col="title">
                            <input placeholder="화면명" type="text" class="form-control edit-mode">
                        </td>            
                        <td data-col="url">
                            <input placeholder="URL" type="text" class="form-control edit-mode">
                        </td>            
                        <td data-col="status" class="text-center">
                            <input class="form-check-input status-chk" type="checkbox">
                        </td>            
                        <td data-col="body">
                            <textarea placeholder="비고" class="form-control edit-mode"></textarea>
                        </td>            
                        <td class="text-center">
                            <button class="save"></button>
                            <button class="cancel"></button>
                        </td>
                    </tr>
                `;

                    $("#pagesTableBody").append(editTr);
                    $('.new td[data-col="title"] input').focus();
                }

                // 검색
                $("#searchConfirm").on("click", function () {
                    const searchTerm = $("#searchTerm").val().trim().toLowerCase();
                    let searchResultLength = 0;

                    searchList.each(function (idx, el) {
                        const title = $(this).find('td[data-col="title"] .view-mode').text().trim().toLocaleLowerCase();

                        if (title.includes(searchTerm)) {
                            $(this).css("display", "table-row");
                            searchResultLength++;
                        } else {
                            $(this).hide();
                        }

                        if (searchResultLength == 0) {
                            showNoDataTr();
                        } else {
                            hideNoDataTr();
                        }

                        $("#searchResultWrap").show();
                        $("#searchResult").text(searchResultLength + "개");
                    });
                });

                $("#searchReset").on("click", function () {
                    searchList.each(function (idx, el) {
                        $(this).css("display", "table-row");
                    });

                    $("#searchTerm").val("");
                    $("#searchResultWrap").hide();
                    $("#searchResult").text("");

                    hideNoDataTr();
                });

                // 신규 생성
                $(document).on("click", ".new .save", function () {
                    const $tr = $(this).closest("tr");
                    var dataToSend = getFormData($tr);
                    callAjaxPost(dataToSend, "create-info");
                });

                $(document).on("click", ".new .cancel", function () {
                    const $tr = $(this).closest("tr");

                    $tr.remove();
                });

                // 수정
                $(document).on("click", ".data .edit", function () {
                    const $tr = $(this).closest("tr");

                    $(this).hide();
                    $tr.find(".cancel, .save").show();

                    $tr.find(".edit-mode").show();
                    $tr.find(".view-mode").hide();

                    $tr.find('input[type="checkbox"]').removeAttr("disabled");

                    $tr.find("textarea").keyup();
                });

                // 수정 취소
                $(document).on("click", ".data .cancel", function () {
                    const $tr = $(this).closest("tr");

                    $tr.find("input, textarea").each(function (idx, item) {
                        if ($(this).attr("type") == "checkbox") {
                            const originStatus = $(this).siblings(".status-check").text();
                            const isChecked = originStatus == "checked" ? true : false;

                            $(this).prop("checked", isChecked);
                        }

                        if ($(this).is('input[type="text"]')) {
                            const originTxt = $(this).siblings(".view-mode").text();

                            $(this).val("");
                            $(this).val(originTxt);
                        }

                        if ($(this).is("textarea")) {
                            const originHtml = $(this).siblings(".view-mode").html();

                            if (originHtml) {
                                const originTxt = originHtml.replace(/<br\s*\/?>/gi, "\n");

                                $(this).val("");
                                $(this).val(originTxt);
                            }
                        }
                    });

                    $(this).hide();
                    $tr.find(".save").hide();
                    $tr.find(".edit").show();

                    $tr.find(".edit-mode").hide();
                    $tr.find(".view-mode").show();
                    $tr.find('input[type="checkbox"]').attr("disabled", true);
                });

                // 저장
                $(document).on("click", ".data .save", function () {
                    const $tr = $(this).closest("tr");
                    var dataToSend = getFormData($tr);
                    callAjaxPost(dataToSend, "update-info");
                });

                $(document).on("click", ".delete", function () {
                    const targetId = $(this).closest("tr").attr("data-id");
                    const confirm = window.confirm("정말 삭제하시겠습니까?");

                    if (confirm) {
                        var dataToSend = {
                            id: targetId,
                        };

                        callAjaxPost(dataToSend, "delete-info");
                    }
                });

                // TextArea Height
                $(document).on("keyup", "textarea", function () {
                    $(this).css("height", "auto");
                    $(this).height(this.scrollHeight);
                });
            });
        </script>
    </body>
</html>
